<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‰ãƒŸãƒå€’ã—ã‚²ãƒ¼ãƒ </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        
        #container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin: 0 0 20px 0;
            font-size: 28px;
        }
        
        #gameCanvas {
            border: 3px solid #667eea;
            border-radius: 10px;
            display: block;
            margin: 0 auto;
            cursor: crosshair;
            background: linear-gradient(to bottom, #e3f2fd 0%, #fff9c4 100%);
        }
        
        #controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        #placeMode {
            background: #4CAF50;
            color: white;
        }
        
        #placeMode:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        #ballMode {
            background: #2196F3;
            color: white;
        }
        
        #ballMode:hover {
            background: #0b7dda;
            transform: translateY(-2px);
        }
        
        #clearBtn {
            background: #f44336;
            color: white;
        }
        
        #clearBtn:hover {
            background: #da190b;
            transform: translateY(-2px);
        }
        
        #resetBtn {
            background: #FF9800;
            color: white;
        }
        
        #resetBtn:hover {
            background: #e68900;
            transform: translateY(-2px);
        }
        
        .active {
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.5), 0 0 0 6px currentColor;
        }
        
        #info {
            text-align: center;
            margin-top: 15px;
            font-size: 18px;
            color: #333;
            font-weight: bold;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
        }
        
        #score {
            text-align: center;
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 8px;
            border: 2px solid #4CAF50;
        }
        
        #instructions {
            margin-top: 15px;
            padding: 15px;
            background: #e8eaf6;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.8;
        }
        
        #instructions h3 {
            margin-top: 0;
            color: #667eea;
        }
        
        #instructions ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        #instructions li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>ğŸ² ãƒ‰ãƒŸãƒå€’ã—ã‚²ãƒ¼ãƒ </h1>
        
        <canvas id="gameCanvas" width="850" height="500"></canvas>
        
        <div id="info">ãƒ¢ãƒ¼ãƒ‰: ãƒ‰ãƒŸãƒé…ç½®</div>
        
        <div id="score">
            <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px;">
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">
                        ğŸ† ãƒ‰ãƒŸãƒ: <span id="successCount">0</span> å€‹
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        åˆæœŸé…ç½®ã‚’å´©ã•ãšè¿½åŠ 
                    </div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #2196F3;">
                        âš½ ãƒœãƒ¼ãƒ«: <span id="ballCount">0</span> å€‹
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        æŠ•ä¸‹ã—ãŸæ•°
                    </div>
                </div>
            </div>
        </div>
        
        <div id="controls">
            <button id="placeMode" class="active">ğŸ¯ ãƒ‰ãƒŸãƒé…ç½®</button>
            <button id="ballMode">âš½ ãƒœãƒ¼ãƒ«æŠ•ä¸‹</button>
            <button id="clearBtn">ğŸ—‘ï¸ å…¨ã¦ã‚¯ãƒªã‚¢</button>
            <button id="resetBtn">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        
        <div id="instructions">
            <h3>ğŸ“– éŠã³æ–¹</h3>
            <ul>
                <li><strong>ç›®æ¨™:</strong> åˆæœŸé…ç½®ã®ãƒ‰ãƒŸãƒã‚’å´©ã•ãšã«ã€ã§ãã‚‹ã ã‘å¤šãã®ãƒ‰ãƒŸãƒã‚’è¿½åŠ ã—ã‚ˆã†ï¼</li>
                <li><strong>åˆæœŸé…ç½®:</strong> ç¸¦6å€‹Ã—æ¨ª10åˆ—ã®ã‚«ãƒ©ãƒ•ãƒ«ãªãƒ‰ãƒŸãƒã‚¿ãƒ¯ãƒ¼ãŒé…ç½®ã•ã‚Œã¦ã„ã¾ã™</li>
                <li><strong>è¿½åŠ ãƒ‰ãƒŸãƒ:</strong> ã‚¯ãƒªãƒƒã‚¯ã§ç·‘è‰²ã®ãƒ‰ãƒŸãƒã‚’è¿½åŠ ã§ãã¾ã™ï¼ˆå€’ã‚Œãšã«ç½®ã‘ãŸæ•°ãŒã‚¹ã‚³ã‚¢ã«ãªã‚Šã¾ã™ï¼‰</li>
                <li><strong>ãƒœãƒ¼ãƒ«æŠ•ä¸‹:</strong> ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ãƒœãƒ¼ãƒ«ã‚’è½ã¨ã›ã¾ã™ï¼ˆæŠ•ä¸‹ã—ãŸæ•°ã‚‚ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã¾ã™ï¼‰</li>
                <li><strong>ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼:</strong> åˆæœŸé…ç½®ã®ãƒ‰ãƒŸãƒãŒå€’ã‚Œã‚‹ã¨ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</li>
                <li><strong>ãƒªã‚»ãƒƒãƒˆ:</strong> åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¦ã‚¹ã‚³ã‚¢ã‚‚ãƒªã‚»ãƒƒãƒˆã—ã¾ã™</li>
            </ul>
        </div>
    </div>

    <script>
        const { Engine, Render, World, Bodies, Mouse, MouseConstraint, Runner, Body, Events } = Matter;

        // ã‚¨ãƒ³ã‚¸ãƒ³ã¨ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã®ä½œæˆ
        const engine = Engine.create();
        const world = engine.world;
        world.gravity.y = 1;

        const canvas = document.getElementById('gameCanvas');
        const render = Render.create({
            canvas: canvas,
            engine: engine,
            options: {
                width: 850,
                height: 500,
                wireframes: false,
                background: 'transparent'
            }
        });

        // ã‚¹ãƒãƒ›åˆ¤å®šï¼ˆã‚¹ãƒãƒ›ã ã‘3ãƒ¬ãƒ¼ãƒ³é›£æ˜“åº¦ã«åˆ†å²ï¼‰
        const isMobile = window.matchMedia('(max-width: 600px)').matches;

        // ã‚¹ãƒãƒ›ç”¨ï¼š3ãƒ¬ãƒ¼ãƒ³ï¼ˆå·¦=Easy / ä¸­=Normal / å³=Hardï¼‰
        const laneXRatios = [0.25, 0.5, 0.75];
        function snapToLaneX(x) {
            if (!isMobile) return x;
            let best = laneXRatios[0] * render.options.width;
            let bestDist = Math.abs(x - best);
            for (let i = 1; i < laneXRatios.length; i++) {
                const lx = laneXRatios[i] * render.options.width;
                const d = Math.abs(x - lx);
                if (d < bestDist) { bestDist = d; best = lx; }
            }
            return best;
        }

        // åœ°é¢ã‚’ä½œæˆ
        const ground = Bodies.rectangle(425, 490, 850, 20, { 
            isStatic: true,
            render: {
                fillStyle: '#8B4513'
            }
        });
        World.add(world, ground);

        // å·¦å³ã®å£
        const leftWall = Bodies.rectangle(10, 250, 20, 500, { 
            isStatic: true,
            render: {
                fillStyle: '#8B4513'
            }
        });
        const rightWall = Bodies.rectangle(840, 250, 20, 500, { 
            isStatic: true,
            render: {
                fillStyle: '#8B4513'
            }
        });
        World.add(world, [leftWall, rightWall]);

        // ãƒ‰ãƒŸãƒã¨ãƒœãƒ¼ãƒ«ã®é…åˆ—
        let dominoes = [];
        let balls = [];
        let mode = 'place'; // 'place' or 'ball'
        let addedDominoes = []; // è¿½åŠ ã—ãŸãƒ‰ãƒŸãƒ
        let successCount = 0; // æˆåŠŸã‚«ã‚¦ãƒ³ãƒˆ
        let ballCount = 0; // ãƒœãƒ¼ãƒ«ã‚«ã‚¦ãƒ³ãƒˆ
        let gameOver = false; // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ©ã‚°

        // ãƒ‰ãƒŸãƒãŒå€’ã‚ŒãŸã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆè§’åº¦ã§åˆ¤å®šï¼‰
        function isDominoFallen(domino) {
            const angle = Math.abs(domino.angle);
            // 15åº¦ä»¥ä¸Šå‚¾ã„ãŸã‚‰å€’ã‚ŒãŸã¨åˆ¤å®š
            return angle > 0.26; // ç´„15åº¦
        }

        // åˆæœŸé…ç½®ï¼šç¸¦6å€‹Ã—æ¨ª10åˆ—ã®ãƒ‰ãƒŸãƒã‚’ä½œæˆ
        function createInitialDominoes() {
            const dominoWidth = 15;
            const dominoHeight = 80;
            const startY = 400; // é–‹å§‹ä½ç½®Yï¼ˆåœ°é¢ã‹ã‚‰å°‘ã—ä¸Šï¼‰
            const spacingY = dominoHeight + 2; // ç¸¦ã®é–“éš”ï¼ˆå°‘ã—é‡ã­ã‚‹ï¼‰

            // ã‚¹ãƒãƒ›ç‰ˆï¼š3ãƒ¬ãƒ¼ãƒ³ã«é›£æ˜“åº¦ã‚’æŒ¯ã‚Šåˆ†ã‘ï¼ˆå·¦=Easy / ä¸­=Normal / å³=Hardï¼‰
            if (isMobile) {
                const rowsByLane = [4, 6, 8];
                const laneColors = ['#4CAF50', '#FFC107', '#F44336']; // ç·‘/é»„/èµ¤
                const lanePhysics = [
                    { friction: 0.9, restitution: 0.05, angleJitter: 0.0 },   // Easy: å®‰å®š
                    { friction: 0.8, restitution: 0.1,  angleJitter: 0.01 },  // Normal
                    { friction: 0.6, restitution: 0.15, angleJitter: 0.03 }   // Hard: ã¡ã‚‡ã„ä¸å®‰å®š
                ];

                for (let lane = 0; lane < 3; lane++) {
                    const x = laneXRatios[lane] * render.options.width;
                    for (let row = 0; row < rowsByLane[lane]; row++) {
                        const y = startY - row * spacingY;
                        const p = lanePhysics[lane];
                        const domino = Bodies.rectangle(x, y, dominoWidth, dominoHeight, {
                            density: 0.005,
                            friction: p.friction,
                            restitution: p.restitution,
                            render: { fillStyle: laneColors[lane] }
                        });

                        // Hardã»ã©ã€ã»ã‚“ã®å°‘ã—ã ã‘åˆæœŸè§’åº¦ã«æºã‚‰ãï¼ˆã‚¹ãƒãƒ›ã®ã€Œé›£ã—ã„æ„Ÿã€ï¼‰
                        if (p.angleJitter > 0) {
                            const a = (Math.random() * 2 - 1) * p.angleJitter;
                            Body.setAngle(domino, a);
                        }

                        domino.isInitial = true;
                        dominoes.push(domino);
                        World.add(world, domino);
                    }
                }
                return;
            }

            // PCç‰ˆï¼šç¸¦6å€‹Ã—æ¨ª10åˆ—ã®ãƒ‰ãƒŸãƒã‚’ä½œæˆï¼ˆå¾“æ¥ã©ãŠã‚Šï¼‰
            const rows = 6; // ç¸¦ã«ç©ã‚€æ•°
            const cols = 10; // æ¨ªã®åˆ—æ•°
            const startX = 100; // é–‹å§‹ä½ç½®X
            const spacingX = 70; // åˆ—é–“ã®é–“éš”

            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B739', '#52B788'];

            for (let col = 0; col < cols; col++) {
                for (let row = 0; row < rows; row++) {
                    const x = startX + col * spacingX;
                    const y = startY - row * spacingY;
                    const domino = Bodies.rectangle(x, y, dominoWidth, dominoHeight, {
                        density: 0.005,
                        friction: 0.8,
                        restitution: 0.1,
                        render: {
                            fillStyle: colors[col % colors.length]
                        }
                    });
                    domino.isInitial = true; // åˆæœŸé…ç½®ãƒ•ãƒ©ã‚°
                    dominoes.push(domino);
                    World.add(world, domino);
                }
            }
        }

        // ç‰©ç†æ¼”ç®—ã®æ›´æ–°ã”ã¨ã«ãƒã‚§ãƒƒã‚¯
        Events.on(engine, 'afterUpdate', () => {
            if (gameOver) return;

            // åˆæœŸé…ç½®ã®ãƒ‰ãƒŸãƒãŒå€’ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
            for (let domino of dominoes) {
                if (domino.isInitial && isDominoFallen(domino)) {
                    gameOver = true;
                    document.getElementById('info').textContent = 'âŒ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼åˆæœŸé…ç½®ãŒå´©ã‚Œã¾ã—ãŸ';
                    document.getElementById('info').style.background = '#ffcdd2';
                    document.getElementById('info').style.color = '#c62828';
                    return;
                }
            }

            // è¿½åŠ ã—ãŸãƒ‰ãƒŸãƒãŒå€’ã‚ŒãŸã‚‰ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰é™¤å¤–
            addedDominoes = addedDominoes.filter(domino => {
                if (!isDominoFallen(domino)) {
                    return true;
                } else {
                    // å€’ã‚ŒãŸã®ã§ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰é™¤å¤–
                    return false;
                }
            });
        });

        // åˆæœŸé…ç½®ã‚’å®Ÿè¡Œ
        createInitialDominoes();

        // ãƒ‰ãƒŸãƒã‚’ä½œæˆã™ã‚‹é–¢æ•°
        function createDomino(x, y) {
            if (gameOver) {
                alert('ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã§ã™ã€‚ãƒªã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const domino = Bodies.rectangle(x, y, 15, 80, {
                density: 0.005,
                friction: 0.8,
                restitution: 0.1,
                render: {
                    fillStyle: '#4CAF50' // è¿½åŠ ã—ãŸãƒ‰ãƒŸãƒã¯ç·‘è‰²
                }
            });
            domino.isInitial = false; // è¿½åŠ ã—ãŸãƒ‰ãƒŸãƒãƒ•ãƒ©ã‚°
            dominoes.push(domino);
            addedDominoes.push(domino);
            World.add(world, domino);
            
            // æˆåŠŸã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
            successCount++;
            document.getElementById('successCount').textContent = successCount;
        }

        // ãƒœãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹é–¢æ•°
        function createBall(x, y) {
            const ball = Bodies.circle(x, y, 20, {
                density: 0.02,
                friction: 0.5,
                restitution: 0.8,
                render: {
                    fillStyle: '#FF5722'
                }
            });
            balls.push(ball);
            World.add(world, ball);
            
            // ãƒœãƒ¼ãƒ«ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
            ballCount++;
            document.getElementById('ballCount').textContent = ballCount;
        }

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
        canvas.addEventListener('click', (event) => {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            if (mode === 'place') {
                // ãƒ‰ãƒŸãƒã‚’é…ç½®ï¼ˆåœ°é¢ã‚ˆã‚Šä¸Šã«ã®ã¿ï¼‰
                if (y < 450) {
                    const sx = snapToLaneX(x);
                    createDomino(sx, y);
                }
            } else if (mode === 'ball') {
                // ãƒœãƒ¼ãƒ«ã‚’æŠ•ä¸‹
                createBall(x, y);
            }
        });

        // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ãƒœã‚¿ãƒ³
        document.getElementById('placeMode').addEventListener('click', () => {
            mode = 'place';
            document.getElementById('info').textContent = 'ãƒ¢ãƒ¼ãƒ‰: ãƒ‰ãƒŸãƒé…ç½®';
            document.getElementById('placeMode').classList.add('active');
            document.getElementById('ballMode').classList.remove('active');
            canvas.style.cursor = 'crosshair';
        });

        document.getElementById('ballMode').addEventListener('click', () => {
            mode = 'ball';
            document.getElementById('info').textContent = 'ãƒ¢ãƒ¼ãƒ‰: ãƒœãƒ¼ãƒ«æŠ•ä¸‹';
            document.getElementById('ballMode').classList.add('active');
            document.getElementById('placeMode').classList.remove('active');
            canvas.style.cursor = 'pointer';
        });

        // å…¨ã¦ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
        document.getElementById('clearBtn').addEventListener('click', () => {
            // ãƒ‰ãƒŸãƒã‚’å‰Šé™¤
            dominoes.forEach(domino => {
                World.remove(world, domino);
            });
            dominoes = [];
            
            // ãƒœãƒ¼ãƒ«ã‚’å‰Šé™¤
            balls.forEach(ball => {
                World.remove(world, ball);
            });
            balls = [];
            
            // ã‚¹ã‚³ã‚¢ã‚‚ãƒªã‚»ãƒƒãƒˆ
            addedDominoes = [];
            successCount = 0;
            ballCount = 0;
            gameOver = false;
            document.getElementById('successCount').textContent = '0';
            document.getElementById('ballCount').textContent = '0';
            document.getElementById('info').textContent = 'ãƒ¢ãƒ¼ãƒ‰: ãƒ‰ãƒŸãƒé…ç½®';
            document.getElementById('info').style.background = '#f0f0f0';
            document.getElementById('info').style.color = '#333';
        });

        // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
        document.getElementById('resetBtn').addEventListener('click', () => {
            // å…¨ã¦ã®ãƒ‰ãƒŸãƒã¨ãƒœãƒ¼ãƒ«ã‚’å‰Šé™¤
            dominoes.forEach(domino => {
                World.remove(world, domino);
            });
            balls.forEach(ball => {
                World.remove(world, ball);
            });
            
            // ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ã‚¯ãƒªã‚¢
            Engine.clear(engine);
            
            // åœ°é¢ã¨å£ã‚’å†è¿½åŠ 
            World.add(world, [ground, leftWall, rightWall]);
            
            // é…åˆ—ã¨ã‚¹ã‚³ã‚¢ã‚’ã‚¯ãƒªã‚¢
            dominoes = [];
            balls = [];
            addedDominoes = [];
            successCount = 0;
            ballCount = 0;
            gameOver = false;
            
            // UIæ›´æ–°
            document.getElementById('successCount').textContent = '0';
            document.getElementById('ballCount').textContent = '0';
            document.getElementById('info').textContent = 'ãƒ¢ãƒ¼ãƒ‰: ãƒ‰ãƒŸãƒé…ç½®';
            document.getElementById('info').style.background = '#f0f0f0';
            document.getElementById('info').style.color = '#333';
            
            // åˆæœŸé…ç½®ã‚’å†ä½œæˆ
            createInitialDominoes();
        });

        // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹
        Render.run(render);
        const runner = Runner.create();
        Runner.run(runner, engine);
    </script>
</body>
</html>
